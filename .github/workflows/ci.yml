name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  MILL_VERSION: "0.12.17"
  OPENLANE_IMAGE: "ghcr.io/efabless/openlane2:2.0.4"
  OPEN_PDKS_REV: "0fe599b2afb6708d281543108caf8310912f54af"
  PDK: "sky130A"
  SCL: "sky130_fd_sc_hd"

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    outputs:
      util_ideal_s4_array: ${{ steps.util_metrics.outputs.ideal_s4_array }}
      util_ideal_s16_array: ${{ steps.util_metrics.outputs.ideal_s16_array }}
      util_ideal_s4_stream: ${{ steps.util_metrics.outputs.ideal_s4_stream }}
      util_ideal_s16_stream: ${{ steps.util_metrics.outputs.ideal_s16_stream }}
      util_randlat_s4_stream: ${{ steps.util_metrics.outputs.randlat_s4_stream }}
      util_randlat_s16_stream: ${{ steps.util_metrics.outputs.randlat_s16_stream }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Mill and Coursier
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/coursier
            ~/.mill/ammonite
            ~/.mill/download
          key: ${{ runner.os }}-mill-${{ hashFiles('build.mill', '.mill-version') }}
          restore-keys: |
            ${{ runner.os }}-mill-

      - name: Install Verilator
        run: |
          sudo apt-get update
          sudo apt-get install -y verilator

      - name: Install Mill 0.12.17
        run: |
          curl -fsSL "https://repo1.maven.org/maven2/com/lihaoyi/mill-dist/${MILL_VERSION}/mill-dist-${MILL_VERSION}-mill.sh" -o mill
          chmod +x mill

      - name: Build
        run: ./mill --no-server spinal101.compile

      - name: Test (Verilator)
        id: sim_test
        run: |
          mkdir -p build/ci
          set -o pipefail
          ./mill --no-server spinal101.test | tee build/ci/verilator-test.log

      - name: Test Summary
        if: ${{ always() }}
        run: |
          echo "## Scala/Verilator Tests" >> "$GITHUB_STEP_SUMMARY"
          echo "- Result: \`${{ steps.sim_test.outcome }}\`" >> "$GITHUB_STEP_SUMMARY"
          if [[ -f build/ci/verilator-test.log ]]; then
            test_count="$(grep -Eo 'Total number of tests run: [0-9]+' build/ci/verilator-test.log | tail -n1 | awk '{print $6}')"
            if [[ -n "${test_count:-}" ]]; then
              echo "- Tests executed: ${test_count}" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

      - name: Utilization Metrics Summary
        if: ${{ always() }}
        id: util_metrics
        run: |
          python3 - <<'PY'
          import glob
          import os

          summary_path = os.environ["GITHUB_STEP_SUMMARY"]
          output_path = os.environ["GITHUB_OUTPUT"]
          metric_files = sorted(glob.glob("build/utilization_gates/*.metrics.env"))

          default_outputs = {
              "ideal_s4_array": "n/a",
              "ideal_s16_array": "n/a",
              "ideal_s4_stream": "n/a",
              "ideal_s16_stream": "n/a",
              "randlat_s4_stream": "n/a",
              "randlat_s16_stream": "n/a",
          }

          with open(output_path, "a", encoding="utf-8") as out_f:
              for key, value in default_outputs.items():
                  out_f.write(f"{key}={value}\n")

          if not metric_files:
              with open(summary_path, "a", encoding="utf-8") as summary_f:
                  summary_f.write("## Utilization Gates\n")
                  summary_f.write("- No utilization metrics were generated.\n")
              raise SystemExit(0)

          rows = []
          by_key = {}
          for path in metric_files:
              data = {}
              with open(path, "r", encoding="utf-8") as in_f:
                  for line in in_f:
                      line = line.strip()
                      if not line or line.startswith("#") or "=" not in line:
                          continue
                      k, v = line.split("=", 1)
                      data[k] = v
              rows.append(data)
              by_key[(data.get("scenario", ""), data.get("s", ""))] = data

          with open(summary_path, "a", encoding="utf-8") as summary_f:
              summary_f.write("## Utilization Gates\n")
              summary_f.write("| Scenario | S | Array Util | Stream Util | no_step | a_not_ready | bank_hazard | out_bp | err_flush |\n")
              summary_f.write("| --- | --- | --- | --- | --- | --- | --- | --- | --- |\n")
              for row in rows:
                  summary_f.write(
                      f"| {row.get('scenario', 'n/a')} | {row.get('s', 'n/a')} | "
                      f"{row.get('array_utilization', 'n/a')} | {row.get('stream_utilization', 'n/a')} | "
                      f"{row.get('stall_no_step_cycles', 'n/a')} | {row.get('stall_a_not_ready_cycles', 'n/a')} | "
                      f"{row.get('stall_bank_hazard_cycles', 'n/a')} | {row.get('stall_output_backpressure_cycles', 'n/a')} | "
                      f"{row.get('stall_error_flush_cycles', 'n/a')} |\n"
                  )

              summary_f.write("\n### Utilization Trend (S4 vs S16)\n")
              summary_f.write("| Scenario | S4 Array | S16 Array | S4 Stream | S16 Stream |\n")
              summary_f.write("| --- | --- | --- | --- | --- |\n")
              for scenario in [
                  "ideal",
                  "random_latency",
                  "backpressure_bp0",
                  "backpressure_bp1",
                  "backpressure_bp2",
                  "backpressure_bp3",
              ]:
                  s4 = by_key.get((scenario, "4"), {})
                  s16 = by_key.get((scenario, "16"), {})
                  summary_f.write(
                      f"| {scenario} | {s4.get('array_utilization', 'n/a')} | {s16.get('array_utilization', 'n/a')} | "
                      f"{s4.get('stream_utilization', 'n/a')} | {s16.get('stream_utilization', 'n/a')} |\n"
                  )

          exports = {
              "ideal_s4_array": by_key.get(("ideal", "4"), {}).get("array_utilization", "n/a"),
              "ideal_s16_array": by_key.get(("ideal", "16"), {}).get("array_utilization", "n/a"),
              "ideal_s4_stream": by_key.get(("ideal", "4"), {}).get("stream_utilization", "n/a"),
              "ideal_s16_stream": by_key.get(("ideal", "16"), {}).get("stream_utilization", "n/a"),
              "randlat_s4_stream": by_key.get(("random_latency", "4"), {}).get("stream_utilization", "n/a"),
              "randlat_s16_stream": by_key.get(("random_latency", "16"), {}).get("stream_utilization", "n/a"),
          }
          with open(output_path, "a", encoding="utf-8") as out_f:
              for key, value in exports.items():
                  out_f.write(f"{key}={value}\n")
          PY

      - name: Upload test log
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: verilator-test-log
          path: build/ci/verilator-test.log

      - name: Upload utilization metrics
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: utilization-gate-metrics
          path: build/utilization_gates

  openlane-prepnr:
    runs-on: ubuntu-latest
    outputs:
      gate_count: ${{ steps.export_metrics.outputs.gate_count }}
      worst_slack_ns: ${{ steps.export_metrics.outputs.worst_slack_ns }}
      critical_path_ns: ${{ steps.export_metrics.outputs.critical_path_ns }}
      max_frequency_mhz: ${{ steps.export_metrics.outputs.max_frequency_mhz }}
      critical_startpoint: ${{ steps.export_metrics.outputs.critical_startpoint }}
      critical_endpoint: ${{ steps.export_metrics.outputs.critical_endpoint }}
      critical_path_delay_ns: ${{ steps.export_metrics.outputs.critical_path_delay_ns }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Python 3
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache Mill and Coursier
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/coursier
            ~/.mill/ammonite
            ~/.mill/download
          key: ${{ runner.os }}-mill-${{ hashFiles('build.mill', '.mill-version') }}
          restore-keys: |
            ${{ runner.os }}-mill-

      - name: Install Mill
        run: |
          curl -fsSL "https://repo1.maven.org/maven2/com/lihaoyi/mill-dist/${MILL_VERSION}/mill-dist-${MILL_VERSION}-mill.sh" -o mill
          chmod +x mill

      - name: Cache SKY130 PDK
        uses: actions/cache@v4
        with:
          path: ./.volare-sky130
          key: ${{ runner.os }}-sky130-pdk-${{ env.OPEN_PDKS_REV }}
          restore-keys: |
            ${{ runner.os }}-sky130-pdk-

      - name: Install Volare
        run: python3 -m pip install --upgrade pip volare

      - name: Enable SKY130 PDK
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 -m volare enable --pdk sky130 --pdk-root ./.volare-sky130 "${OPEN_PDKS_REV}"

      - name: Resolve SKY130 PDK Path
        id: pdk_path
        run: |
          pdk_path="$(python3 -m volare path --pdk sky130 --pdk-root ./.volare-sky130 "${OPEN_PDKS_REV}")"
          echo "pdk_path=${pdk_path}" >> "$GITHUB_OUTPUT"
          echo "Resolved PDK path: ${pdk_path}"

      - name: Run OpenLane Pre-PnR Flow
        run: |
          docker pull "${OPENLANE_IMAGE}"
          make prepnr \
            OPENLANE_PDK_ROOT="${{ steps.pdk_path.outputs.pdk_path }}" \
            PREPNR_S=4

      - name: Export OpenLane Metrics
        id: export_metrics
        run: |
          source build/openlane_prepnr/metrics.env
          echo "gate_count=${gate_count}" >> "$GITHUB_OUTPUT"
          echo "worst_slack_ns=${worst_slack_ns}" >> "$GITHUB_OUTPUT"
          echo "critical_path_ns=${critical_path_ns}" >> "$GITHUB_OUTPUT"
          echo "max_frequency_mhz=${max_frequency_mhz}" >> "$GITHUB_OUTPUT"
          echo "critical_startpoint=${critical_startpoint}" >> "$GITHUB_OUTPUT"
          echo "critical_endpoint=${critical_endpoint}" >> "$GITHUB_OUTPUT"
          echo "critical_path_delay_ns=${critical_path_delay_ns}" >> "$GITHUB_OUTPUT"

      - name: OpenLane Summary
        if: ${{ always() }}
        run: |
          if [[ -f build/openlane_prepnr/summary.md ]]; then
            cat build/openlane_prepnr/summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## OpenLane Pre-PnR Metrics (SKY130)" >> "$GITHUB_STEP_SUMMARY"
            echo "- Flow did not complete; see uploaded logs." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload OpenLane reports
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: openlane-prepnr-reports
          path: |
            build/openlane_prepnr

  report:
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs:
      - build-and-test
      - openlane-prepnr
    steps:
      - name: Combined CI Summary
        env:
          TEST_RESULT: ${{ needs.build-and-test.result }}
          OPENLANE_RESULT: ${{ needs.openlane-prepnr.result }}
          UTIL_IDEAL_S4_ARRAY: ${{ needs.build-and-test.outputs.util_ideal_s4_array }}
          UTIL_IDEAL_S16_ARRAY: ${{ needs.build-and-test.outputs.util_ideal_s16_array }}
          UTIL_IDEAL_S4_STREAM: ${{ needs.build-and-test.outputs.util_ideal_s4_stream }}
          UTIL_IDEAL_S16_STREAM: ${{ needs.build-and-test.outputs.util_ideal_s16_stream }}
          UTIL_RANDLAT_S4_STREAM: ${{ needs.build-and-test.outputs.util_randlat_s4_stream }}
          UTIL_RANDLAT_S16_STREAM: ${{ needs.build-and-test.outputs.util_randlat_s16_stream }}
          GATE_COUNT: ${{ needs.openlane-prepnr.outputs.gate_count }}
          MAX_FREQUENCY_MHZ: ${{ needs.openlane-prepnr.outputs.max_frequency_mhz }}
          WORST_SLACK_NS: ${{ needs.openlane-prepnr.outputs.worst_slack_ns }}
          CRITICAL_PATH_NS: ${{ needs.openlane-prepnr.outputs.critical_path_ns }}
          CRITICAL_STARTPOINT: ${{ needs.openlane-prepnr.outputs.critical_startpoint }}
          CRITICAL_ENDPOINT: ${{ needs.openlane-prepnr.outputs.critical_endpoint }}
          CRITICAL_PATH_DELAY_NS: ${{ needs.openlane-prepnr.outputs.critical_path_delay_ns }}
        run: |
          echo "## CI Result Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Scala/Verilator tests | ${TEST_RESULT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| OpenLane pre-PnR flow | ${OPENLANE_RESULT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Gate count (std cells) | ${GATE_COUNT:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Worst slack (ns) | ${WORST_SLACK_NS:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Critical path estimate (ns) | ${CRITICAL_PATH_NS:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Critical path delay (report_checks, ns) | ${CRITICAL_PATH_DELAY_NS:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Critical path startpoint | ${CRITICAL_STARTPOINT:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Critical path endpoint | ${CRITICAL_ENDPOINT:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Max frequency estimate (MHz) | ${MAX_FREQUENCY_MHZ:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Utilization Gate Trend" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | S=4 | S=16 |" >> "$GITHUB_STEP_SUMMARY"
          echo "| --- | --- | --- |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Ideal array utilization | ${UTIL_IDEAL_S4_ARRAY:-n/a} | ${UTIL_IDEAL_S16_ARRAY:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Ideal stream utilization | ${UTIL_IDEAL_S4_STREAM:-n/a} | ${UTIL_IDEAL_S16_STREAM:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Random-latency stream utilization | ${UTIL_RANDLAT_S4_STREAM:-n/a} | ${UTIL_RANDLAT_S16_STREAM:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
