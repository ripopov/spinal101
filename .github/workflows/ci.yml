name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  MILL_VERSION: "0.12.17"
  OPENLANE_IMAGE: "ghcr.io/efabless/openlane2:2.0.4"
  OPEN_PDKS_REV: "0fe599b2afb6708d281543108caf8310912f54af"
  PDK: "sky130A"
  SCL: "sky130_fd_sc_hd"

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Mill and Coursier
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/coursier
            ~/.mill/ammonite
            ~/.mill/download
          key: ${{ runner.os }}-mill-${{ hashFiles('build.mill', '.mill-version') }}
          restore-keys: |
            ${{ runner.os }}-mill-

      - name: Install Verilator
        run: |
          sudo apt-get update
          sudo apt-get install -y verilator

      - name: Install Mill 0.12.17
        run: |
          curl -fsSL "https://repo1.maven.org/maven2/com/lihaoyi/mill-dist/${MILL_VERSION}/mill-dist-${MILL_VERSION}-mill.sh" -o mill
          chmod +x mill

      - name: Build
        run: ./mill --no-server spinal101.compile

      - name: Test (Verilator)
        id: sim_test
        run: |
          mkdir -p build/ci
          set -o pipefail
          ./mill --no-server spinal101.test | tee build/ci/verilator-test.log

      - name: Test Summary
        if: ${{ always() }}
        run: |
          echo "## Scala/Verilator Tests" >> "$GITHUB_STEP_SUMMARY"
          echo "- Result: \`${{ steps.sim_test.outcome }}\`" >> "$GITHUB_STEP_SUMMARY"
          if [[ -f build/ci/verilator-test.log ]]; then
            test_count="$(grep -Eo 'Total number of tests run: [0-9]+' build/ci/verilator-test.log | tail -n1 | awk '{print $6}')"
            if [[ -n "${test_count:-}" ]]; then
              echo "- Tests executed: ${test_count}" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

      - name: Upload test log
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: verilator-test-log
          path: build/ci/verilator-test.log

  openlane-prepnr:
    runs-on: ubuntu-latest
    outputs:
      gate_count: ${{ steps.export_metrics.outputs.gate_count }}
      worst_slack_ns: ${{ steps.export_metrics.outputs.worst_slack_ns }}
      critical_path_ns: ${{ steps.export_metrics.outputs.critical_path_ns }}
      max_frequency_mhz: ${{ steps.export_metrics.outputs.max_frequency_mhz }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Python 3
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache Mill and Coursier
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/coursier
            ~/.mill/ammonite
            ~/.mill/download
          key: ${{ runner.os }}-mill-${{ hashFiles('build.mill', '.mill-version') }}
          restore-keys: |
            ${{ runner.os }}-mill-

      - name: Install Mill
        run: |
          curl -fsSL "https://repo1.maven.org/maven2/com/lihaoyi/mill-dist/${MILL_VERSION}/mill-dist-${MILL_VERSION}-mill.sh" -o mill
          chmod +x mill

      - name: Generate RTL
        run: ./mill --no-server spinal101.run

      - name: Cache SKY130 PDK
        uses: actions/cache@v4
        with:
          path: ./.volare-sky130
          key: ${{ runner.os }}-sky130-pdk-${{ env.OPEN_PDKS_REV }}
          restore-keys: |
            ${{ runner.os }}-sky130-pdk-

      - name: Install Volare
        run: python3 -m pip install --upgrade pip volare

      - name: Enable SKY130 PDK
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 -m volare enable --pdk sky130 --pdk-root ./.volare-sky130 "${OPEN_PDKS_REV}"

      - name: Run OpenLane Pre-PnR Flow
        run: |
          chmod +x .github/scripts/openlane_prepnr.sh
          docker pull "${OPENLANE_IMAGE}"
          docker run --rm \
            -u "$(id -u):$(id -g)" \
            -v "$PWD":"$PWD" \
            -w "$PWD" \
            -e PDK_ROOT="$PWD/.volare-sky130" \
            -e PDK="${PDK}" \
            -e SCL="${SCL}" \
            -e DESIGN_NAME="Fp32MatrixMul" \
            -e RTL_PATH="generated/Fp32MatrixMul.v" \
            "${OPENLANE_IMAGE}" \
            bash .github/scripts/openlane_prepnr.sh

      - name: Export OpenLane Metrics
        id: export_metrics
        run: |
          source build/openlane_prepnr/metrics.env
          echo "gate_count=${gate_count}" >> "$GITHUB_OUTPUT"
          echo "worst_slack_ns=${worst_slack_ns}" >> "$GITHUB_OUTPUT"
          echo "critical_path_ns=${critical_path_ns}" >> "$GITHUB_OUTPUT"
          echo "max_frequency_mhz=${max_frequency_mhz}" >> "$GITHUB_OUTPUT"

      - name: OpenLane Summary
        if: ${{ always() }}
        run: |
          if [[ -f build/openlane_prepnr/summary.md ]]; then
            cat build/openlane_prepnr/summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## OpenLane Pre-PnR Metrics (SKY130)" >> "$GITHUB_STEP_SUMMARY"
            echo "- Flow did not complete; see uploaded logs." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload OpenLane reports
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: openlane-prepnr-reports
          path: |
            build/openlane_prepnr

  report:
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs:
      - build-and-test
      - openlane-prepnr
    steps:
      - name: Combined CI Summary
        env:
          TEST_RESULT: ${{ needs.build-and-test.result }}
          OPENLANE_RESULT: ${{ needs.openlane-prepnr.result }}
          GATE_COUNT: ${{ needs.openlane-prepnr.outputs.gate_count }}
          MAX_FREQUENCY_MHZ: ${{ needs.openlane-prepnr.outputs.max_frequency_mhz }}
          WORST_SLACK_NS: ${{ needs.openlane-prepnr.outputs.worst_slack_ns }}
          CRITICAL_PATH_NS: ${{ needs.openlane-prepnr.outputs.critical_path_ns }}
        run: |
          echo "## CI Result Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Scala/Verilator tests | ${TEST_RESULT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| OpenLane pre-PnR flow | ${OPENLANE_RESULT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Gate count (std cells) | ${GATE_COUNT:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Worst slack (ns) | ${WORST_SLACK_NS:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Critical path estimate (ns) | ${CRITICAL_PATH_NS:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Max frequency estimate (MHz) | ${MAX_FREQUENCY_MHZ:-n/a} |" >> "$GITHUB_STEP_SUMMARY"
